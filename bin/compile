#!/usr/bin/env ruby
# frozen_string_literal: true

$:.unshift(File.expand_path("../lib", __dir__))
require "regular_expression"

require "crabstone"

pattern = RegularExpression::Pattern.new(ARGV.shift)
pattern.bytecode.dump
puts

cfg_builder = RegularExpression::CFG::Builder.new
cfg = cfg_builder.build(pattern.bytecode)
cfg.dump
puts
RegularExpression::CFG::Graph.to_dot(cfg)

compiled = RegularExpression::Compiler::Ruby.compile(cfg)
puts compiled.source
puts

matcher = compiled.to_proc

ARGV.each do |string|
  puts "#{string}: #{matcher.call(string)}"
end
puts

compiled = RegularExpression::Compiler::X86.compile(cfg)
puts compiled.disasm
puts

matcher = compiled.to_proc

ARGV.each do |string|
  puts "#{string}: #{matcher.call(string)}"
end
